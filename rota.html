<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sua Rota - Rota Certa</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-dark: #0a0f1a;
      --bg-card: #111827;
      --bg-input: #1f2937;
      --border: #374151;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --accent: #f59e0b;
      --danger: #ef4444;
      --danger-bg: rgba(239, 68, 68, 0.15);
      --warning: #f59e0b;
      --warning-bg: rgba(245, 158, 11, 0.15);
      --success: #10b981;
      --info: #3b82f6;
      --info-bg: rgba(59, 130, 246, 0.15);
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
    }

    /* Header Compacto */
    .header {
      background: linear-gradient(135deg, var(--accent) 0%, #d97706 100%);
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .header-icon {
      font-size: 1.75rem;
    }

    .header-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: #000;
    }

    .header-subtitle {
      font-size: 0.8125rem;
      color: rgba(0,0,0,0.7);
    }

    /* Route Info */
    .route-info {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 1.25rem;
    }

    .route-path {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .route-dots {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding-top: 0.25rem;
    }

    .route-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--success);
    }

    .route-dot.end {
      background: var(--danger);
    }

    .route-line {
      width: 2px;
      height: 30px;
      background: var(--border);
    }

    .route-locations {
      flex: 1;
    }

    .route-location {
      margin-bottom: 0.75rem;
    }

    .route-location:last-child {
      margin-bottom: 0;
    }

    .route-location-label {
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 0.125rem;
    }

    .route-location-value {
      font-size: 0.9375rem;
      font-weight: 500;
      line-height: 1.3;
    }

    .route-meta {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .route-meta-item {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      background: var(--bg-input);
      padding: 0.375rem 0.625rem;
      border-radius: 6px;
    }

    .route-meta-item span:first-child {
      font-size: 1rem;
    }

    /* Mapa */
    .map-container {
      height: 35vh;
      min-height: 250px;
      background: var(--bg-input);
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .map-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
    }

    .map-placeholder-icon {
      font-size: 3rem;
      margin-bottom: 0.5rem;
      opacity: 0.5;
    }

    /* Alertas */
    .alerts-section {
      padding: 1.25rem;
    }

    .alerts-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .alerts-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .alerts-count {
      background: var(--danger);
      color: #fff;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0.125rem 0.5rem;
      border-radius: 10px;
    }

    .alert-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border-left: 4px solid;
    }

    .alert-card.danger {
      border-left-color: var(--danger);
      background: var(--danger-bg);
    }

    .alert-card.warning {
      border-left-color: var(--warning);
      background: var(--warning-bg);
    }

    .alert-card.info {
      border-left-color: var(--info);
      background: var(--info-bg);
    }

    .alert-header {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .alert-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
    }

    .alert-title {
      font-weight: 600;
      font-size: 0.9375rem;
      line-height: 1.3;
    }

    .alert-message {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-left: 2rem;
      line-height: 1.4;
    }

    .alert-description {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      margin-left: 2rem;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border);
      opacity: 0.8;
    }

    /* Notas */
    .notes-section {
      padding: 0 1.25rem 1.25rem;
    }

    .notes-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
    }

    .notes-title {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .notes-content {
      font-size: 0.9375rem;
      line-height: 1.5;
    }

    /* Bot√£o Fixo */
    .fixed-bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1rem 1.25rem;
      background: linear-gradient(to top, var(--bg-dark) 80%, transparent);
      padding-top: 2rem;
    }

    .btn-navigate {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-family: inherit;
      font-size: 1.0625rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-navigate:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-navigate:active {
      transform: translateY(0);
    }

    .btn-icon {
      font-size: 1.5rem;
    }

    /* Padding bottom para o bot√£o fixo */
    .content-padding {
      padding-bottom: 100px;
    }

    /* Loading */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      gap: 1rem;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error */
    .error-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 2rem;
      text-align: center;
    }

    .error-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .error-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .error-message {
      color: var(--text-secondary);
    }

    /* No alerts */
    .no-alerts {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .no-alerts-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    /* Hide sections */
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Loading State -->
  <div class="loading-container" id="loadingState">
    <div class="loading-spinner"></div>
    <div>Carregando rota...</div>
  </div>

  <!-- Error State -->
  <div class="error-container hidden" id="errorState">
    <div class="error-icon">üö´</div>
    <div class="error-title">Rota n√£o encontrada</div>
    <div class="error-message">Este link pode ter expirado ou ser inv√°lido.</div>
  </div>

  <!-- Content -->
  <div class="hidden" id="content">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="header-icon">üöõ</div>
        <div>
          <div class="header-title">Sua Rota</div>
          <div class="header-subtitle" id="driverGreeting">Boa viagem!</div>
        </div>
      </div>
    </header>

    <!-- Route Info -->
    <section class="route-info">
      <div class="route-path">
        <div class="route-dots">
          <div class="route-dot"></div>
          <div class="route-line"></div>
          <div class="route-dot end"></div>
        </div>
        <div class="route-locations">
          <div class="route-location">
            <div class="route-location-label">Origem</div>
            <div class="route-location-value" id="originText">-</div>
          </div>
          <div class="route-location">
            <div class="route-location-label">Destino</div>
            <div class="route-location-value" id="destinationText">-</div>
          </div>
        </div>
      </div>

      <div class="route-meta">
        <div class="route-meta-item">
          <span>üöõ</span>
          <span id="vehicleText">-</span>
        </div>
        <div class="route-meta-item" id="plateContainer" style="display:none;">
          <span>üî¢</span>
          <span id="plateText">-</span>
        </div>
      </div>
    </section>

    <!-- Map -->
    <section class="map-container">
      <div id="map"></div>
    </section>

    <div class="content-padding">
      <!-- Alerts -->
      <section class="alerts-section">
        <div class="alerts-header">
          <span>‚ö†Ô∏è</span>
          <h2 class="alerts-title">Aten√ß√£o no Trajeto</h2>
          <span class="alerts-count" id="alertsCount">0</span>
        </div>

        <div id="alertsList">
          <div class="no-alerts">
            <div class="no-alerts-icon">‚úÖ</div>
            <div>Nenhum alerta para esta rota!</div>
          </div>
        </div>
      </section>

      <!-- Notes -->
      <section class="notes-section hidden" id="notesSection">
        <div class="notes-card">
          <div class="notes-title">
            <span>üìù</span>
            <span>Observa√ß√µes</span>
          </div>
          <div class="notes-content" id="notesText"></div>
        </div>
      </section>
    </div>

    <!-- Fixed Button -->
    <div class="fixed-bottom">
      <button class="btn-navigate" id="navigateBtn" onclick="openNavigation()">
        <span class="btn-icon">üß≠</span>
        <span>Abrir no Google Maps</span>
      </button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Estado
    let routeData = null;
    let map = null;

    // Obter ID da rota da URL
    const routeId = window.location.pathname.split('/').pop();

    // Carregar dados da rota
    async function loadRoute() {
      try {
        const response = await fetch(`/api/routes/${routeId}`);
        
        if (!response.ok) {
          showError();
          return;
        }

        routeData = await response.json();
        renderRoute();
      } catch (error) {
        console.error('Erro ao carregar rota:', error);
        showError();
      }
    }

    // Mostrar erro
    function showError() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
    }

    // Renderizar rota
    function renderRoute() {
      // Esconder loading, mostrar conte√∫do
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');

      // Sauda√ß√£o personalizada
      if (routeData.driverName) {
        document.getElementById('driverGreeting').textContent = 
          `Ol√°, ${routeData.driverName}! Boa viagem!`;
      }

      // Info da rota
      document.getElementById('originText').textContent = routeData.origin;
      document.getElementById('destinationText').textContent = routeData.destination;
      document.getElementById('vehicleText').textContent = routeData.vehicle.name;

      // Placa
      if (routeData.vehiclePlate) {
        document.getElementById('plateContainer').style.display = 'flex';
        document.getElementById('plateText').textContent = routeData.vehiclePlate;
      }

      // Alertas
      renderAlerts();

      // Notas
      if (routeData.notes) {
        document.getElementById('notesSection').classList.remove('hidden');
        document.getElementById('notesText').textContent = routeData.notes;
      }

      // Mapa
      initMap();
    }

    // Renderizar alertas
    function renderAlerts() {
      const alerts = routeData.alerts;
      document.getElementById('alertsCount').textContent = alerts.length;

      if (alerts.length === 0) {
        return;
      }

      const container = document.getElementById('alertsList');
      container.innerHTML = alerts.map(alert => {
        const icon = getAlertIcon(alert.severity);
        return `
          <div class="alert-card ${alert.severity}">
            <div class="alert-header">
              <span class="alert-icon">${icon}</span>
              <div class="alert-title">${alert.name}</div>
            </div>
            <div class="alert-message">${alert.message}</div>
            ${alert.description !== alert.message ? 
              `<div class="alert-description">${alert.description}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // √çcone do alerta
    function getAlertIcon(severity) {
      switch (severity) {
        case 'danger': return 'üö´';
        case 'warning': return '‚ö†Ô∏è';
        case 'info': return '‚ÑπÔ∏è';
        default: return 'üìç';
      }
    }

    // Inicializar mapa
    function initMap() {
      // Centro aproximado entre SP e Santos
      const centerLat = -23.7;
      const centerLng = -46.5;

      map = L.map('map').setView([centerLat, centerLng], 10);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);

      // Adicionar marcadores dos alertas
      routeData.alerts.forEach(alert => {
        if (alert.lat && alert.lng) {
          const color = alert.severity === 'danger' ? '#ef4444' : 
                       alert.severity === 'warning' ? '#f59e0b' : '#3b82f6';
          
          const marker = L.circleMarker([alert.lat, alert.lng], {
            radius: 10,
            fillColor: color,
            color: '#fff',
            weight: 2,
            fillOpacity: 0.8
          }).addTo(map);

          marker.bindPopup(`
            <strong>${alert.name}</strong><br>
            ${alert.message}
          `);
        }
      });

      // Ajustar zoom para mostrar todos os pontos
      if (routeData.alerts.length > 0) {
        const points = routeData.alerts
          .filter(a => a.lat && a.lng)
          .map(a => [a.lat, a.lng]);
        
        if (points.length > 0) {
          map.fitBounds(points, { padding: [50, 50] });
        }
      }
    }

    // Abrir navega√ß√£o no Google Maps
    function openNavigation() {
      const origin = encodeURIComponent(routeData.origin);
      const destination = encodeURIComponent(routeData.destination);
      
      // URL do Google Maps com dire√ß√µes
      const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving`;
      
      window.open(mapsUrl, '_blank');
    }

    // Iniciar
    loadRoute();
  </script>
</body>
</html>
